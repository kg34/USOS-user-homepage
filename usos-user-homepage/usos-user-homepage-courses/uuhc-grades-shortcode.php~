<?php

function uuhc_grades_shortcode_function($atts) {
	return uuhc_get_user_grades();
// 	$atts = shortcode_atts(array(
// 		'description' => true,
// 		'visitors_info' => '',
// 		), $atts);
// 		
// 	$select_atts = array(
// 		'name' => true,
// 		'description' => $atts['description'],
// 		);
// 		
//  	$current_user = wp_get_current_user();
//  	$user_id = $current_user->ID;
// 
// 	if (! $user_id)
// 		return $atts['visitors_info'];
// 
// //	uuhc_database_delete_usos_courses($user_id);
// //	uuhc_get_user_courses();
// 		
// 	$courses = uuhc_database_get_current_courses($user_id, $select_atts);
// 	$output = '<table class="form-table editcomment"><tr><h2>Courses</h2></tr>';// class="form table">';
// 	foreach ( $courses as $course ) {
// 			$line = '';
// 			foreach ( $course as $value )
// 				$line = $line.'<td>'.$value.'</td>';
// 			$output = $output.'<tr>'.$line.'</tr>';
// 		}
// 	$output = $output."</table>";
// 	
// 	return $output;
}

add_shortcode('uuh-grades', 'uuhc_grades_shortcode_function');
	
function uuhc_get_user_grades(/*$user_login, $user*/) {
//function uuhc_get_user_grades($user_login, $user) {
//	$user_id = $user->ID;
	
	$current_user = wp_get_current_user();
 	$user_id = $current_user->ID;
 	
	if (! uuh_usos_user($user_id))
		return;
	
	if( ! class_exists( 'Hybrid_Auth', false ) ) {
		require_once WP_PLUGIN_DIR . "/wordpress-social-login/hybridauth/Hybrid/Auth.php";
	}
	$config = wsl_process_login_build_provider_config( "Usosweb");
	try {
		$h = new Hybrid_Auth($config); 
//		Hybrid_Auth::initialize( $config );
//		if( ! Hybrid_Auth::storage()->get( "hauth_session.Usosweb.is_logged_in" ) ){
//			//uuhc_database_delete_usos_courses($user_id);
//			return;
//		}
//		else
//			$adapter = Hybrid_Auth::getAdapter( "Usosweb" );
	$adapter = $h->authenticate( "Usosweb" );
	}
	catch( Exception $e ) {
		return "Ooophs, we got an error: " . $e->getMessage();
	}
	
//	uuhc_database_delete_usos_courses($user_id);
	$response1 = $adapter->api()->get( 'https://usosapps.uw.edu.pl/services/crstests/participant' );
	$response2 = $adapter->api()->get( 'https://usosapps.uw.edu.pl/services/crstests/user_grade?node_id=63401' );
	return print_r($response2, true).'</br>'.print_r($response1, true);
//	foreach ( $response->course_editions as $course_term )
//		foreach ( $course_term as $course )
//			uuhc_add_course($course, $user_id);
}

//add_action('wp_login', 'uuhc_get_user_grades', 10, 2);

require_once( USOS_HOMEPAGE_COURSES_ABS_PATH . '/uuhc.database.php' );

function uuhc_add_grade($response, $user_id) {
// 	$course = array(
// 		'name' => $response->course_name->pl,
// 		'user_id' => $user_id,
// 		'description' => $response->term_id,
// 		'source' => 'usos',
// 		'is_participant' => true
// 	);
// 	uuhc_database_add_course($course);
}
?>
