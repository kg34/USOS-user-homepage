<?php
$MyConst = false;
function uuhs_menu_page_callback() {
	global $MyConst;
	$MyConst = true;
	?>
	<form action="<?php echo admin_url( 'admin-post.php' ); ?>">
	<input type="hidden" name="action" value="wpse_79898">
	<div class="stuffbox" id="namediv">
		<h3>
			Alabama
		</h3>
			<div class="inside">
				<table class="form-table editcomment">
					<tbody>
						<tr valign="top">
							<td>Event title</td>
							<td><input dir="ltr" type="text" name="title" value="title" ></td>
						</tr>
						<tr valign="top">
							<td>Event description</td>
							<td><input dir="ltr" type="text" name="description" value="description" ></td>
						</tr>
						<tr valign="top">
							<td>Event date</td>
							<td><input dir="ltr" type="date" name="date" min = "<?php echo date('Y-m-d') ?>" max="9999-12-31" value="<?php echo date('Y-m-d') ?>"></td>
						</tr>
						<tr valign="top">
							<td>Event start hour</td>
							<td><input dir="ltr" type="time" name="start_hour" value="00:00"></td>
						</tr>
						<tr valign="top">
							<td>Event end hour</td>
							<td><input dir="ltr" type="time" name="end_hour" value="00:00"></td>
						</tr>
					</tbody>
				</table>
			</div>
	</div>
	<input type="submit" class="button-primary" value="<?php _wsl_e("Send aha", 'wordpress-social-login') ?>" />
	<?php submit_button( 'Send' ); ?>
	</form>
	<?php
}

function wpse_79898_test() {

	global $MyConst;
	if(! $MyConst) {
		die('Direct access not permitted');
	}


	if (! isset ( $_GET['title'] ) or ! isset ( $_GET['description'] ) or
		! isset ( $_GET['date'] ) or ! isset ( $_GET['start_hour'] ) or
		! isset ( $_GET['end_hour'] ) or
		! validateDate($_GET['date'], 'Y-m-d') or
		! validateDate($_GET['start_hour'], 'H:i') or
		! validateDate($_GET['end_hour'], 'H:i') )
	{
		echo "Oszukujemy?</br>";
		return;
	}
	$event = array(
		'title' => esc_html( $_GET['title'] ),
		'description' => esc_html( $_GET['description'] ),
		'user_id' => wp_get_current_user()->ID,
		'source' => 'wp'
	);
	$time = array(
		'date' => esc_html( $_GET['date'] ),
		'day_of_week' => '',
		'start_hour' => esc_html( $_GET['start_hour'] ),
		'end_hour' => esc_html( $_GET['end_hour'] )
	);
	print_r($time);
	/*
	if ( isset ( $_GET['date'] ) )
		$event['date'] = esc_html( $_GET['date'] );
	if ( isset ( $_GET['start_hour'] ) )
		$event['start_hour'] = esc_html( $_GET['start_hour'] );
	if ( isset ( $_GET['end_hour'] ) )
		$event['end_hour'] = esc_html( $_GET['end_hour'] );
	foreach ($event as $value)
		echo $value.'</br>';
    //    echo esc_html( $_GET['title'] );
/*	$start = explode(" ", $response->start_time);
	$end = explode(" ", $response->end_time);
	$time = array(
		'date' => $start[0],
		'day_of_week' => 0,
		'start_hour'=> $start[1],
		'end_hour' => $end[1],
		'source' => 'usos'
	);
	$times = array(
		0 => $time,
	);
*/
    if ( isset ( $_GET['title'] ) )
        echo esc_html( $_GET['title'] );
	echo 'No rewelacja';
	?>
	<form action="<?php echo admin_url( 'admin.php' ); ?>">
		<input type="hidden" name="page" value="uuh_settings">
		<button class="button-primary">Return</button> 
	</form>
	<a href="<?php echo admin_url( 'admin.php?page=uuh_settings' ); ?>">Return</a>
	<?php
    //die( __FUNCTION__ );
}

add_action( 'admin_post_wpse_79898', 'wpse_79898_test' );

function uuhs_menu_page_add_event($response, $user_id) {
	$event = array(
		'title' => $response->name->pl,
		'user_id' => $user_id,
		'description' => '',
		'source' => 'usos'
	);
	$start = explode(" ", $response->start_time);
	$end = explode(" ", $response->end_time);
	$time = array(
		'date' => $start[0],
		'day_of_week' => 0,
		'start_hour'=> $start[1],
		'end_hour' => $end[1],
		'source' => 'usos'
	);
	$times = array(
		0 => $time,
	);
	uuhs_database_add_event($event, $times);
}

function validateDate($date, $format = 'Y-m-d H:i:s')
{
    $d = DateTime::createFromFormat($format, $date);
    return $d && $d->format($format) == $date;
}

?>
